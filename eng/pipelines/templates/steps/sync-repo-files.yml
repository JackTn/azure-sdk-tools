parameters:
  # JackTn/TestRepo-One:
  #   Branch: "main"
  #   Path: "/specification/common-types/"
  #   TargetRepos:
  #     JackTn/TestRepo-Two:
  #       Branch: "main"
  #       Path: "/specification/common-types/"
  #     JackTn/TestRepo-Three:
  #       Branch: "main"
  #       Path: "/specification/common-types/"
  - name: Repos
    type: object
  # Github PAT
  - name: GH_TOKEN
    type: string

steps:

- ${{ each repo in parameters.Repos }}:
  - pwsh: |
      Set-PsDebug -Trace 1
      $SourceRepo = '${{ repo.key }}'
      $SourceFolder = $SourceRepo -split "/" -join "-"
      $SourceBranch = '${{ repo.value.Branch }}'
      if (-not (Test-Path ${{ repo.key }})) {
        New-Item -Path ${{ repo.key }} -ItemType Directory -Force
        Set-Location $SourceFolder
        git init
        git remote add Source "https://${{ parameters.GH_TOKEN }}@github.com/${SourceRepo}.git"
      } else {
        Set-Location $SourceFolder
      }

      # Check the default branch
      if (!$SourceBranch) {
        $defaultBranch = (git remote show Source | Out-String) -replace "(?ms).*HEAD branch: (\w+).*", '$1'
        Write-Host "No source branch. Fetch default branch $defaultBranch."
        $SourceBranch = $defaultBranch
      }

      git fetch --no-tags Source $SourceBranch
      if ($LASTEXITCODE -ne 0) {
        Write-Host "#`#vso[task.logissue type=error]Failed to fetch ${SourceRepo}:${SourceBranch}"
        exit 1
      }

      git checkout -B source_branch "refs/remotes/Source/${SourceBranch}"

      Set-PsDebug -Off

    displayName: ${{ repo.key }} - Clone ${{ repo.value.Branch }}
    continueOnError: true

